<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendario de Vacaciones</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7f9fc;
    }
    #calendar-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .fc {
        height: 80vh; 
    }
    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 600;
        color: #1e293b;
    }
    .fc-button-primary {
        background-color: #4285F4 !important;
        border-color: #4285F4 !important;
        transition: background-color 0.2s;
    }
    .fc-button-primary:hover {
        background-color: #3367D6 !important;
    }
    .fc-event-user-current {
        border: 2px solid #3367D6;
        cursor: pointer;
    }
</style>
</head>
<body class="p-4 md:p-8">

<!-- Header -->
<div class="header-bar bg-white p-4 shadow-md rounded-lg mb-6 flex justify-between items-center max-w-7xl mx-auto">
    <div>
        <h1 class="text-2xl font-bold text-gray-800">
            Calendario de Vacaciones
        </h1>
        <p class="text-sm text-gray-600">
            Sesión iniciada como: <span class="font-semibold" id="current-username">{{ current_user.username }}</span>
            {% if current_user.is_admin %}
                <span class="text-xs bg-red-100 text-red-700 py-0.5 px-2 rounded-full font-bold ml-2">ADMIN</span>
            {% endif %}
        </p>
    </div>
    <div class="flex space-x-3">
        {% if current_user.is_admin %}
            <a href="{{ url_for('export_vacations') }}" 
               class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                <!-- Icono Excel -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Exportar Excel
            </a>
        {% endif %}
        <a href="{{ url_for('logout') }}" 
           class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
            Cerrar Sesión
        </a>
    </div>
</div>

<!-- Contenedor del Calendario -->
<div id="calendar-container">
    <div id="calendar"></div>
</div>

<!-- Toast mensajes -->
<div id="toast-message" class="fixed bottom-5 right-5 bg-blue-600 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300"></div>

<!-- FullCalendar JS (bundle global) -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
    const currentUserId = {{ current_user.id }};
    const currentUserColor = '{{ current_user.color }}';

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast-message');
        toast.textContent = message;
        toast.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600');
        if (type === 'success') toast.classList.add('bg-green-600');
        else if (type === 'error') toast.classList.add('bg-red-600');
        else toast.classList.add('bg-blue-600');
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            events: '/get_vacations',
            eventDisplay: 'block',
            eventDidMount: function(info) {
                if (parseInt(info.event.extendedProps.id_usuario) === currentUserId) {
                    info.el.classList.add('fc-event-user-current');
                    info.el.title = "Click para eliminar esta vacación.";
                } else {
                    info.el.title = info.event.title;
                }
            },
            dateClick: function(info) {
                toggleVacation(info.dateStr);
            },
            eventClick: function(info) {
                const eventUserId = parseInt(info.event.extendedProps.id_usuario);
                const eventDate = info.event.startStr;
                if (eventUserId !== currentUserId) {
                    showToast(`No puedes eliminar las vacaciones de ${info.event.title}.`, 'error');
                    return;
                }
                if (confirm(`¿Eliminar tu vacación del ${eventDate}?`)) {
                     toggleVacation(eventDate, false, info.event);
                }
            }
        });
        calendar.render();

        function toggleVacation(dateStr, isAdding = true, eventToRemove = null) {
            fetch('/toggle_vacation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: dateStr })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const existingEvents = calendar.getEvents().filter(event =>
                        event.startStr === dateStr && 
                        parseInt(event.extendedProps.id_usuario) === currentUserId
                    );
                    if (existingEvents.length > 0) {
                        existingEvents.forEach(e => e.remove());
                        showToast("Vacación eliminada.", 'info');
                    } else {
                        calendar.addEvent({
                            title: '{{ current_user.username }}',
                            start: dateStr,
                            end: dateStr,
                            allDay: true,
                            backgroundColor: currentUserColor,
                            id_usuario: currentUserId
                        });
                        showToast("Vacación marcada.", 'success');
                    }
                } else {
                    showToast("Error al procesar la solicitud.", 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast("Error de conexión con el servidor.", 'error');
            });
        }

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    showToast("{{ message }}", "{{ category }}");
                {% endfor %}
            {% endif %}
        {% endwith %}
    });
</script>
</body>
</html>
